
server {
	listen 443 ssl http2;
	listen [::]:443 ssl http2;
	client_max_body_size 20M;
	server_name opencrvs.jembi.org;

	error_log /var/log/nginx/error.log debug;
	
	# Use the Letâ€™s Encrypt certificates
	ssl_certificate /etc/letsencrypt/live/opencrvs.jembi.org/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/opencrvs.jembi.org/privkey.pem;

	access_log /home/webroots/default/logs/access.log;
  error_log  /home/webroots/default/logs/error.log;

	# Include the SSL configuration from cipherli.st
	include snippets/ssl-params.conf;

	root /var/www/OpenCRVS-production/front/opencrvs-web-client/build;
	index index.html index.htm;

	location ~* \.(?:manifest|appcache|html?|xml|json)$ {
		add_header Access-Control-Allow-Origin *;
		expires -1;
		client_max_body_size 20M;
	}

	location ~* \.(?:css|js)$ {
		add_header Access-Control-Allow-Origin *;
		try_files $uri =404;
		expires 1y;
		access_log off;
		add_header Cache-Control "public";
		client_max_body_size 20M;
	}

	location ~ ^.+\..+$ {
		add_header Access-Control-Allow-Origin *;
		try_files $uri =404;
	}

	location /auth {
		proxy_set_header Access-Control-Allow-Origin *;
		proxy_pass http://46.101.36.211:3000;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
		proxy_set_header Host $host;
		proxy_cache_bypass $http_upgrade;

		client_max_body_size 20M;

		client_body_buffer_size 128k;
		client_body_temp_path /var/nginx/client_body_temp;
		proxy_connect_timeout 70;
		proxy_send_timeout 90;
		proxy_read_timeout 90;
		proxy_buffer_size 4k;
		proxy_buffers 4 32k;
		proxy_busy_buffers_size 64k;
		proxy_temp_file_write_size 64k;
		proxy_temp_path /var/nginx/proxy_temp;
	}

	location / {
		add_header Access-Control-Allow-Origin *;
		try_files $uri $uri/ /index.html;
		client_max_body_size 20M;
	}

	location /api/documents/uploads {
    root /var/www/OpenCRVS-production/server/authorisation/src/routes/documents/uploads;
    try_files $uri $uri/ ;

    expires max;
    access_log off;
	}

	location /api {
		proxy_set_header Access-Control-Allow-Origin *;
		proxy_pass http://46.101.36.211:3000;
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection 'upgrade';
		proxy_set_header Host $host;
		proxy_cache_bypass $http_upgrade;

		client_max_body_size 20M;

		client_body_buffer_size 128k;
		client_body_temp_path /var/nginx/client_body_temp;
		proxy_connect_timeout 70;
		proxy_send_timeout 90;
		proxy_read_timeout 90;
		proxy_buffer_size 4k;
		proxy_buffers 4 32k;
		proxy_busy_buffers_size 64k;
		proxy_temp_file_write_size 64k;
		proxy_temp_path /var/nginx/proxy_temp;
	}
}
