# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.
#
# OpenCRVS is also distributed under the terms of the Civil Registration
# & Healthcare Disclaimer located at http://opencrvs.org/license.
#
# Copyright (C) The OpenCRVS Authors. OpenCRVS and the OpenCRVS
# graphic logo are (registered/a) trademark(s) of Plan International.
# Manual server setup notes

# OpenCRVS infrastructure should be setup using the Ansible playbook script "playbook.yml".  
# This text file outlines some notes describing steps for manual installation and will be deprecated.

# add users
curl https://github.com/rcrichton.keys >> ~/.ssh/authorized_keys
curl https://github.com/euanmillar.keys >> ~/.ssh/authorized_keys
curl https://github.com/rikukissa.keys >> ~/.ssh/authorized_keys
curl https://github.com/mushrafulhoque-dsi.keys  >> ~/.ssh/authorized_keys

# prevent password login
sed -i 's/PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# install docker
curl -fsSL get.docker.com -o get-docker.sh
sh get-docker.sh

# create swarm
# on manger:
docker swarm init --advertise-addr <MANAGER-IP>

# on workers (the command is given to you when the manager inits, but something like):
docker swarm join --token <TOKEN> opencrvs-staging.jembi.org:2377

# check state from manager:
docker node ls
# login to private registry on all nodes
docker login

# on manger, create required directories
mkdir -p /data/mongo
mkdir -p /data/traefik
mkdir -p /data/elasticsearch
chmod g+rwx /data/elasticsearch
chgrp 1000 /data/elasticsearch
echo vm.max_map_count=262144 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
mkdir -p /data/influxdb
touch /data/traefik/acme.json
chmod 600 /data/traefik/acme.json

# on all nodes
Add this to the crontab to clean up autodeploys ->
  0 0 * * * /usr/bin/docker system prune -f >> /var/log/docker-prune.log

# set up a cron job to backup data every 24 hours.  Keeps history for a week
