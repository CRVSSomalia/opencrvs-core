# Manual server setup notes

# add users
curl https://github.com/rcrichton.keys >> ~/.ssh/authorized_keys
curl https://github.com/euanmillar.keys >> ~/.ssh/authorized_keys
curl https://github.com/rikukissa.keys >> ~/.ssh/authorized_keys
curl https://github.com/mushrafulhoque-dsi.keys  >> ~/.ssh/authorized_keys

# prevent password login
sed -i 's/PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# install docker
curl -fsSL get.docker.com -o get-docker.sh
sh get-docker.sh

# create swarm
# on manger:
docker swarm init --advertise-addr <MANAGER-IP>

# on workers (the command is given to you when the manager inits, but something like):
docker swarm join --token <TOKEN> opencrvs-staging.jembi.org:2377

# check state from manager:
docker node ls
# login to private registry on all nodes
docker login

# on manger, create required directories
mkdir -p /data/mongo
mkdir -p /data/traefik
mkdir -p /data/elasticsearch
chmod g+rwx /data/elasticsearch
chgrp 1000 /data/elasticsearch
echo vm.max_map_count=262144 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
mkdir -p /data/influxdb
touch /data/traefik/acme.json
chmod 600 /data/traefik/acme.json

# on all nodes
Add this to the crontab to clean up autodeploys ->
  0 0 * * * /usr/bin/docker system prune -f >> /var/log/docker-prune.log

# After deploy:
in resource service container: FHIR_URL=http://hearth:3447/fhir yarn populate
in user mgnt service container: yarn populate

# Copy the 2 locations.json files that are generated in the following directory in the resource package to the other running resources container.  You need to check Docker swarm

/usr/src/app/src/features/administrative/generated/bn/locations.json
/usr/src/app/src/features/facilities/generated/bn/locations.json


